<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.winter.app.users.UsersDAO"> 
    <resultMap type="UsersDTO" id="usersResult">
	    <id column="username" property="username"/>
	    
	    <result column="password" property="password"/>
	    <result column="name" property="name"/>
	    <result column="email" property="email"/>
	    <result column="phone" property="phone"/>
	    <result column="birth" property="birth"/>
	    
	    <collection property="profileDTOs" javaType="java.util.List" ofType="com.winter.app.users.UsersFileDTO"> 
	        <id column="file_num" property="fileNum"/>
	        <result column="file_name" property="fileName"/>
	        <result column="file_origin" property="fileOrigin"/>
	    </collection>
		</resultMap>

		<insert id="register" parameterType="UsersDTO">
        INSERT INTO users (
            username, 
            password, 
            name, 
            email, 
            phone, 
            birth
        ) VALUES (
            #{username}, 
            #{password}, 
            #{name}, 
            #{email}, 
            #{phone}, 
            #{birth}
        )
    </insert>
    
    <select id="detail" resultMap="usersResult" parameterType="UsersDTO">
    SELECT U.*, P.file_num, P.file_name, P.file_origin
    FROM users U
    LEFT JOIN profile P ON U.username = P.username
    WHERE U.username = #{username}
</select>

    <insert id="profileAdd" parameterType="com.winter.app.users.UsersFileDTO">
        INSERT INTO profile (file_name, file_origin, username) 
        VALUES (#{fileName}, #{fileOrigin}, #{username});
    </insert>

		<update id="update" parameterType="UsersDTO">
    UPDATE users SET 
        name=#{name}, 
        email=#{email}, 
        phone=#{phone}, 
        birth=#{birth}
        <if test="password != null and password != ''">
            , password=#{password}
        </if>
    WHERE username=#{username}
</update>
    
    <delete id="delete" parameterType="UsersDTO">
        DELETE FROM users 
        WHERE username=#{username}
    </delete>
    
    <delete id="profileDelete" parameterType="String">
        DELETE FROM profile 
        WHERE username=#{username}
    </delete>
</mapper>