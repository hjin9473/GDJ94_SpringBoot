<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="com.winter.app.board.qna.QnaDAO"> 
    	
    	<select id="detail" resultType="QnaDTO" parameterType="QnaDTO">
    		SELECT * FROM qna 
    		WHERE 
    		board_num=#{boardNum}
    	</select>
    	
    	<select id="count" resultType="Long" parameterType="Pager">
    SELECT COUNT(board_num) FROM qna
    <where>
        <if test="kind != null and search != null and search != ''">
            <if test="kind == 'k1'">
                board_title LIKE concat('%',#{search},'%')
            </if>
            <if test="kind == 'k2'">
                board_contents LIKE concat('%',#{search},'%')
            </if>
            <if test="kind == 'k3'">
                board_writer LIKE concat('%',#{search},'%')
            </if>
        </if>
    </where>
</select>
    	  
       <select id="list" resultType="QnaDTO" parameterType="Pager">
			    SELECT * FROM qna 
			    <if test="kind == 'k1'">
			    WHERE 
			       board_title LIKE concat('%',#{search},'%')
			    </if>
			    <if test="kind == 'k2'">
			    WHERE 
			       board_contents LIKE concat('%',#{search},'%')
			    </if>
			    <if test="kind == 'k3'">
			    WHERE 
			       board_writer LIKE concat('%',#{search},'%')
			    </if>
			    
			    ORDER BY board_ref DESC, board_step ASC
			    LIMIT #{startNum}, #{perPage}
			</select>
    	<!-- 등록하기 -->
    	<insert id="add" parameterType="QnaDTO" useGeneratedKeys="true" keyProperty="boardNum">
    		INSERT INTO qna (
                board_title, 
                board_writer, 
                board_contents, 
                board_date, 
                board_hit,
                board_ref,      board_step,     board_depth     )
    		VALUES (
                #{boardTitle}, 
                #{boardWriter}, 
                #{boardContents}, 
                now(), 
                0,
                0,
                0,
                0
            )
    	</insert>
    	
    	<update id="refUpdate" parameterType="QnaDTO" >
    	UPDATE qna SET board_ref=#{boardNum} WHERE board_num = #{boardNum}
    	</update>
    	
    	<!-- 삭제하기 -->
    	<delete id="delete" parameterType="QnaDTO">
    		DELETE FROM qna WHERE board_num=#{boardNum} 
    	</delete>
    	
    	<!-- 수정하기 -->
    	<update id="update" parameterType="QnaDTO">
    		UPDATE qna SET board_title=#{boardTitle}, board_contents=#{boardContents} 
    		WHERE board_num=#{boardNum}
    	</update>
    	
    	<update id="stepUpdate" parameterType="QnaDTO">
    		UPDATE qna SET board_step=board_step+1
    		WHERE board_ref = #{boardRef} AND board_step > #{boardStep}
    	</update>
    	
    	<insert id="reply" parameterType="QnaDTO">
    		INSERT INTO qna (
                board_title, 
                board_writer, 
                board_contents, 
                board_date, 
                board_hit,
                board_ref, board_step, board_depth)
    		VALUES (
                #{boardTitle}, 
                #{boardWriter}, 
                #{boardContents}, 
                now(), 
                0,
                #{boardRef},      
				        #{boardStep},     
				        #{boardDepth}
            )
    	</insert>
    	
    	<insert id="fileAdd" parameterType="QnaFileDTO">
    		INSERT INTO qna_files (file_name, file_origin, board_num) 
    		VALUES (#{fileName}, #{fileOrigin}, #{boardNum});
    	</insert>
    	

    
    </mapper>